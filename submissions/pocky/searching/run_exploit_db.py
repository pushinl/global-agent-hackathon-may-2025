import sys
import os
from dotenv import load_dotenv
from agents.exploit_db_agent import ExploitDBAgent
from models.openai_agent import OpenAIAgent

def main():
	# Load environment variables from .env file
	load_dotenv()

	# Check command-line argument
	if len(sys.argv) != 2:
		print("Usage: python run_exploit_db.py <cve_json_path>")
		return

	cve_path = sys.argv[1]
	if not os.path.exists(cve_path):
		print(f"[Error] File not found: {cve_path}")
		return

	# Read API keys from environment
	openai_api_key = os.getenv("OPENAI_API_KEY")
	exa_api_key = os.getenv("EXA_API_KEY")

	if not openai_api_key or not exa_api_key:
		print("[Error] OPENAI_API_KEY or EXA_API_KEY not set in .env")
		return

	# Initialize model
	model = OpenAIAgent(
		api_key=openai_api_key,
		model_name="gpt-4o"
	)

	# Initialize agent
	agent = ExploitDBAgent(model=model, api_key=exa_api_key)

	# Run
	result = agent.run(cve_path)

	# Save output
	output_path = cve_path.replace(".json", "_exploitdb.txt")
	with open(output_path, "w", encoding="utf-8") as f:
		f.write(result)

	print(f"[Success] Output saved to: {output_path}")

if __name__ == "__main__":
	main()
